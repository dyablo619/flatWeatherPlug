!function(e,t,a,i){var s="flatWeatherPlugin";console.log("RUNNING");var o={location:"Waterloo, ON",locLat:"42.168877",locLon:"-87.962883",country:"Canada",displayCityNameOnly:!1,api:"openweathermap",forecast:5,apikey:"",view:"full",render:!0,loadingAnimation:!0},n={openweathermap:["https://api.openweathermap.org/data/2.5/onecall"],yahoo:["https://query.yahooapis.com/v1/public/yql"]};function r(t,a){this.element=t,this.settings=e.extend({},o,a),this.settings.forecast=Math.min(this.settings.forecast,5),this._name=s,this.once=!1,this.init()}function d(e){return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e.getDay()]}function p(e){var t=(e=new Date(1e3*e)).getHours(),a=e.getMinutes(),i=t>=12?"PM":"AM";return(t=(t%=12)||12)+":"+(a=a<10?"0"+a:a)+" "+i}e.extend(r.prototype,{init:function(){this.settings.render&&(this.settings.loadingAnimation&&!this.once&&(this.loading=e("<div/>",{id:"flatWeatherLoading",class:"wi loading"}),this.loading.appendTo(this.element)),this.fetchWeather().then(this.render,this.error)),this.once=!0},fetchWeather:function(){var t=this,a=new e.Deferred,i=[],s=this.settings.location;if("openweathermap"==this.settings.api)(o={}).lat=this.settings.locLat,o.lon=this.settings.locLon,o.exclude="hourly,minutely",o.units="imperial",this.settings.apikey&&(o.appid=this.settings.apikey),i.push(o),o.cnt=this.settings.forecast+1,i.push(o);else if("yahoo"==this.settings.api){var o,r="metric"==this.settings.units?"c":"f";(o={}).q="select * from weather.forecast where woeid in (select woeid from geo.places(1) where text='"+s+"') AND u='"+r+"'",o.env="store://datatables.org/alltableswithkeys",o.format="json",i.push(o)}for(var l=[],c=0;c<n[this.settings.api].length;c++)l.push(e.get(n[this.settings.api][c],i[c]));return e.when.apply(this,l).done(function(){var i=Array.prototype.slice.call(arguments);if(console.log(i),l.length>1&&(i=i.map(function(e){return e[0]})),"openweathermap"==t.settings.api&&"success"!=i[1])console.log("Error interacting with the openweathermap api see error object below for details:"),a.reject(i,t);else if("yahoo"!=t.settings.api||0!=i.query.count&&"Yahoo! Weather Error"!=i.query.results.channel.description){var s=function(e,t){var a={};if("openweathermap"==t.api){a.location=t.location,a.city="",a.today={},a.today.temp={},a.today.temp.now=Math.round(e[0].current.temp),a.today.temp.min=Math.round(e[0].daily[0].temp.min),a.today.temp.max=Math.round(e[0].daily[0].temp.max),a.today.desc=e[0].current.weather[0].description.capitalize(),a.today.code=e[0].current.weather[0].id,a.today.wind=e[0].wind,a.today.wind_speed=e[0].current.wind_speed,a.today.wind_deg=e[0].current.wind_deg,a.today.humidity=e[0].current.humidity,a.today.pressure=e[0].current.pressure,a.today.sunrise=p(e[0].current.sunrise),a.today.sunset=p(e[0].current.sunset),a.today.day=d(new Date),a.forecast=[];for(var i=0;i<t.forecast;i++){var s={};s.day=d(new Date(1e3*e[0].daily[i].dt)),s.code=e[0].daily[i].weather[0].id,s.desc=e[0].daily[i].weather[0].description.capitalize(),s.temp={max:Math.round(e[0].daily[i].temp.max),min:Math.round(e[0].daily[i].temp.min)},a.forecast.push(s)}}else if("yahoo"==t.api){var o={0:"900",1:"901",2:"902",3:"212",4:"200",5:"616",6:"612",7:"611",8:"511",9:"301",10:"511",11:"521",12:"521",13:"600",14:"615",15:"601",16:"601",17:"906",18:"611",19:"761",20:"741",21:"721",22:"711",23:"956",24:"954",25:"903",26:"802",27:"802",28:"802",29:"802",30:"802",31:"800",32:"800",33:"951",34:"951",35:"906",36:"904",37:"210",38:"210",39:"210",40:"521",41:"602",42:"621",43:"602",44:"802",45:"201",46:"621",47:"210",3200:"951"};e=e.query.results.channel,a.location=e.location.city+", "+e.location.country,a.city=e.location.city,a.today={},a.today.temp={},a.today.temp.now=Math.round(e.item.condition.temp),a.today.temp.min=Math.round(e.item.forecast[0].low),a.today.temp.max=Math.round(e.item.forecast[0].high),a.today.desc=e.item.condition.text.capitalize(),a.today.code=o[e.item.condition.code],a.today.wind={},a.today.wind.speed=e.wind.speed,a.today.wind.deg=e.wind.direction,a.today.humidity=e.atmosphere.humidity,a.today.pressure=e.atmosphere.pressure,a.today.sunrise=e.astronomy.sunrise.toUpperCase(),a.today.sunset=e.astronomy.sunset.toUpperCase(),a.today.day=d(new Date),a.forecast=[];for(var i=0;i<t.forecast;i++){var s={};s.day=d(new Date(e.item.forecast[i].date)),s.code=o[e.item.forecast[i].code],s.desc=e.item.forecast[i].text.capitalize(),s.temp={max:Math.round(e.item.forecast[i].high),min:Math.round(e.item.forecast[i].low)},a.forecast.push(s)}}return a}(i,t.settings);t._weather=s,e.data(t.element,"weather",s),a.resolve(s,t)}else console.log("Error interacting with the yahoo api see error object below for details:"),a.reject(i,t)}).fail(function(e){a.reject(e,t)}),a},error:function(t,a){a||(a=this),a.settings.loadingAnimation&&a.settings.render&&a.loading.remove(),"openweathermap"==a.settings.api?t="200"!=t[0].cod?t[0].cod+" "+t[0].message+". See console log for details.":t[1]+" See console log for details.":"yahoo"==a.settings.api&&(t=t.query.results?"Error: "+t.query.results.channel.item.title+". See console log for details.":"Error: no results. See console log for details.");var i=e("<div/>",{class:"flatWeatherPlugin "+a.settings.view});return e("<h2/>").text("Error").appendTo(i),e("<p/>").text(t).appendTo(i),e(a.element).html(i),e(a.element)},render:function(t,a){a||(a=this,t=this._weather);var i="metric"==a.settings.units?"&#176;C":"&#176;F";a.settings.loadingAnimation&&a.settings.render&&a.loading.remove();var s=e("<div/>",{class:"flatWeatherPlugin "+a.settings.view});if(e("<h2/>").text(t.location).appendTo(s),"forecast"!=a.settings.view){var o=e("<div/>",{class:"wiToday"}),n=e("<div/>",{class:"wiIconGroup"});e("<div/>",{class:"wi wi"+t.today.code}).appendTo(n),e("<p/>",{class:"wiText"}).text(t.today.desc).appendTo(n),n.appendTo(o),e("<p/>",{class:"wiTemperature"}).html(t.today.temp.now+"<sup>"+i+"</sup>").appendTo(o),o.appendTo(s)}if("simple"!=a.settings.view){var r=e("<div/>",{class:"wiDetail"});if("partial"==a.settings.view&&e("<p/>",{class:"wiDay"}).text(t.today.day).appendTo(o),"partial"!=a.settings.view){"today"!=a.settings.view&&e("<p/>",{class:"wiDay"}).text(t.today.day).appendTo(r);var d=e("<ul/>",{class:"astronomy"}).appendTo(r);e("<li/>",{class:"wi sunrise"}).text(t.today.sunrise).appendTo(d),e("<li/>",{class:"wi sunset"}).text(t.today.sunset).appendTo(d);var p=e("<ul/>",{class:"temp"}).appendTo(r);e("<li/>").html("Max : "+t.today.temp.max+"<sup>"+i+"</sup>").appendTo(p),e("<li/>").html("Min : "+t.today.temp.min+"<sup>"+i+"</sup>").appendTo(p);var l=e("<ul/>",{class:"atmosphere"}).appendTo(r);e("<li/>",{class:"wi humidity"}).text(t.today.humidity).appendTo(l),e("<li/>",{class:"wi pressure"}).text(t.today.pressure).appendTo(l),e("<li/>",{class:"wi wind"}).text(function(e,t,a){var i=t;i>=0&&i<=11.25||i>348.75&&i<=360?i="N":i>11.25&&i<=33.75?i="NNE":i>33.75&&i<=56.25?i="NE":i>56.25&&i<=78.75?i="ENE":i>78.75&&i<=101.25?i="E":i>101.25&&i<=123.75?i="ESE":i>123.75&&i<=146.25?i="SE":i>146.25&&i<=168.75?i="SSE":i>168.75&&i<=191.25?i="S":i>191.25&&i<=213.75?i="SSW":i>213.75&&i<=236.25?i="SW":i>236.25&&i<=258.75?i="WSW":i>258.75&&i<=281.25?i="W":i>281.25&&i<=303.75?i="WNW":i>303.75&&i<=326.25?i="NW":i>326.25&&i<=348.75&&(i="NNW");return i+" "+e+" "+("metric"==a?"km/h":"mph")}(t.today.wind_speed,t.today.wind_deg,a.settings.units)).appendTo(l),r.appendTo(o)}if("today"!=a.settings.view||"forecast"==a.settings.view){for(var c=e("<ul/>",{class:"wiForecasts"}),h="forecast"==a.settings.view?0:1;h<t.forecast.length;h++){var u=e("<li/>",{class:"wiDay"}).html("<span>"+t.forecast[h].day+"</span>").appendTo(c),y=e("<ul/>",{class:"wiForecast"}).appendTo(u);e("<li/>",{class:"wi wi"+t.forecast[h].code}).appendTo(y),e("<li/>",{class:"wiMax"}).html(t.forecast[h].temp.max+"<sup>"+i+"</sup>").appendTo(y),e("<li/>",{class:"wiMin"}).html(t.forecast[h].temp.min+"<sup>"+i+"</sup>").appendTo(y)}c.appendTo(s)}}return e(a.element).html(s),e(a.element)},destroy:function(e){e.remove()}}),e.fn[s]=function(t,a){return e.isFunction(r.prototype[t])?this.data("plugin_"+s)[t](a):this.each(function(){if(!e.data(this,"plugin_"+s)){var a=new r(this,t);return e.data(this,"plugin_"+s,a)}})},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)}}(jQuery,window,document);